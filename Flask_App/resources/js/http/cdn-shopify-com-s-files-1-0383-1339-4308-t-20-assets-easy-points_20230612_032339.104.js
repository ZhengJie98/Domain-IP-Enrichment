function formatBigNumber(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function insertPointValue(t){var e=t.getAttribute("data-loyal-currency-cost"),a=/[^\d]/g,n=Shopify&&Shopify.currency&&Shopify.currency.rate||1,l=e.replace(a,"")/(100*n),r=l*pointRulePercent,o=t.getAttribute("data-loyal-bonus-points");if(o){o=JSON.parse(o);var u=o.pointValue/o.currencyValue,A=o.quantity||1;o.bonusPoints=Math.floor(l*u*A),t.setAttribute("data-loyal-bonus-points",JSON.stringify(o)),r+=o.bonusPoints}t.hasAttribute("data-loyal-cart-subtotal")&&(r+=totalBonusPoints()),t.getAttribute("data-loyal-round")=="up"?r=Math.ceil(r):r=Math.floor(r),insertPointValueIntoElement(t,r)}function insertPointValueIntoElement(t,e){t.querySelectorAll('[data-loyal-target="point-value-location"]').forEach(function(a){a.innerHTML=formatBigNumber(e)})}function totalBonusPoints(){var t=document.querySelectorAll("[data-loyal-bonus-points]"),e={},a=0;t.forEach(function(l){var r=l.getAttribute("data-loyal-bonus-points");r=JSON.parse(r);var o=r.bonusPoints,u=e[r.productId];(!u||u<o)&&(e[r.productId]=o)});var n=Object.values(e);for(i=0;i<n.length;i++)a+=n[i];return a}function pointRedemptionValidation(){var t=document.getElementById("redemption-point-value");if(t){var e=t.value,a=/[^\d]/;if(e.match(a)!=null)return!1;var n=parseInt(e),l=document.querySelectorAll("[data-loyal-target]"),r=Array.prototype.slice.call(l),o="0";r.find(function(L){var q=L.getAttribute("data-loyal-target");if(q=="balance")return o=L.textContent});var u=o.replace(/[^\d]/g,""),A=parseInt(u),I=document.getElementById("redemption-max-points").value;I*=1;var y=Math.min(A,I);return 0<n&&n<=y}}function updateRedemptionForm(){var t=document.getElementById("shown-point-value");if(t){var e=t.value,a=document.getElementById("redemption-point-value");a&&(a.value=e),pointRedemptionValidation()?t.classList.remove("invalid"):t.classList.add("invalid")}}var pointRulePointValue,pointRuleCurrencyValue;if(greaterScriptVersion("0-3-2")){var easyPointsSession=getEasyPointsSession();pointRulePointValue=easyPointsSession.customerPointRulePointValue,pointRuleCurrencyValue=easyPointsSession.customerPointRuleCurrencyValue}else pointRulePointValue=sessionStorage.getItem("customerPointRulePointValue"),pointRuleCurrencyValue=sessionStorage.getItem("customerPointRuleCurrencyValue");var pointRulePercent=null;function htmlRedirectInput(){var t=document.createElement("input");return t.type="text",t.setAttribute("name","html_redirect"),t.value="true",t}function buildForm(t){var e=document.getElementById("point-redemption-form");if(e){var a=Array.from(e.getElementsByTagName("input")),n=document.createElement("form");return n.method="post",n.action=t,n.classList.add("easy-points-hide"),a.forEach(function(l,r){n.appendChild(l.cloneNode())}),n.appendChild(htmlRedirectInput()),n}else return null}function submitForm(t){document.body.appendChild(t),t.submit()}function submitRedemptionForm(){if(updateRedemptionForm(),pointRedemptionValidation()){(widgetRedemptionButton=document.getElementById("widget-redemption-button"))&&(widgetRedemptionButton.setAttribute("disabled",!0),animateButton("widget-redemption-button","\u30DD\u30A4\u30F3\u30C8\u4F7F\u7528\u4E2D")),updateDisplayedDiscount();var t=buildForm("/apps/loyalty/redeem");t&&submitForm(t)}}function updateDisplayedDiscount(){var t=document.getElementById("shown-point-value");greaterScriptVersion("0-3-2")?setEasyPointsSessionItem("appliedDiscount",t.value):sessionStorage.setItem("appliedDiscount",t.value),displayDiscount(t.value.toString())}function submitResetForm(){var t=document.getElementById("widget-reset-button");t&&(t.setAttribute("disabled",!0),animateButton("widget-reset-button","\u30EA\u30BB\u30C3\u30C8\u4E2D")),greaterScriptVersion("0-3-2")?removeEasyPointsSessionItem("appliedDiscount"):sessionStorage.removeItem("appliedDiscount"),displayDiscount("0");var e=buildForm("/apps/loyalty/reset");e&&submitForm(e)}function animateButton(t,e){var a=document.getElementById(t);if(a){a.innerText=e;var n=function(){a.innerText.includes("...")?a.innerText=e:a.innerText=a.innerText+".",setTimeout(n,500)};n()}}function expandWidget(){var t=document.getElementById("widget-container");t&&t.classList.remove("easy-points-hide");var e=document.getElementById("widget-minimized");e&&e.classList.add("easy-points-hide")}function collapseWidget(){var t=document.getElementById("widget-container");t&&t.classList.add("easy-points-hide");var e=document.getElementById("widget-minimized");e&&e.classList.remove("easy-points-hide")}function hideWidget(){greaterScriptVersion("0-3-2")?setEasyPointsSessionItem("widgetHidden",!0):localStorage.setItem("easyPointsWidgetHidden",!0),collapseWidget()}function showWidget(){greaterScriptVersion("0-3-2")?removeEasyPointsSessionItem("widgetHidden"):localStorage.removeItem("easyPointsWidgetHidden"),expandWidget()}function updateDiscountInfo(){var t=document.getElementById("shown-point-value");t&&t.setAttribute("disabled",!0);var e=document.getElementById("widget-reset-button");e&&e.classList.remove("easy-points-hide");var a=document.getElementById("widget-redemption-button");a&&a.classList.add("easy-points-hide")}function displayDiscount(t){var e="\xA5",a="1.0";if(e+=formatBigNumber(t/a).toString(),greaterScriptVersion("0-3-2")){var n=getEasyPointsSession();n.appliedDiscount=t,n.appliedDiscountCurrency=e,setEasyPointsSession(n)}else sessionStorage.setItem("appliedDiscount",t),sessionStorage.setItem("appliedDiscountCurrency",e);displayAppliedDiscount()}function displayAppliedDiscount(){var t,e;if(greaterScriptVersion("0-3-2")){var a=getEasyPointsSession();t=a.appliedDiscount,e=a.appliedDiscountCurrency}else t=sessionStorage.getItem("appliedDiscount"),e=sessionStorage.getItem("appliedDiscountCurrency");eles=document.querySelectorAll('[data-loyal-target="applied-discount"]'),eles.forEach(function(o){o.textContent=e});var n=document.getElementById("shown-point-value");if(n){var l=t.toString().replace(/[^\d]/g,""),r=parseInt(l);n.value=r}}function updatePointValueTargets(){pointRulePercent=pointRulePointValue/pointRuleCurrencyValue;var t=document.querySelectorAll('[data-loyal-target="point-value"]'),e=Array.prototype.slice.call(t),a=[],n=[];e.forEach(function(l){var r=l.getAttribute("data-loyal-bonus-points");(r?a:n).push(l)}),a.concat(n).forEach(function(l){insertPointValue(l)})}function updateLoyaltyTargets(){var t,e;if(greaterScriptVersion("0-3-2")){var a=getEasyPointsSession();t=a.pointBalance,e=a.expirationDate}else t=localStorage.getItem("pointBalance");var n=document.querySelectorAll("[data-loyal-target]"),l=Array.prototype.slice.call(n);l.find(function(r){var o=r.getAttribute("data-loyal-target");o=="shop-point-rule-currency-value"?pointRuleCurrencyValue=pointRuleCurrencyValue||r.value:o=="shop-point-rule-point-value"?pointRulePointValue=pointRulePointValue||r.value:typeof t=="number"&&o=="balance"?r.textContent=formatBigNumber(t):e&&o=="balance-expiration"&&EasyPointsUI.renderBalanceExpiration(e)}),pointRulePointValue&&pointRuleCurrencyValue&&updatePointValueTargets()}function toggleWidgetTierData(){var t=document.getElementById("widget-main");t.classList.toggle("easy-points-hide");var e=document.getElementById("widget-tier-data");e.classList.toggle("easy-points-hide");var a=document.getElementsByClassName("widget-tier-data-toggle-on"),n=Array.prototype.slice.call(a),l=document.getElementsByClassName("widget-tier-data-toggle-off"),r=Array.prototype.slice.call(l);n.concat(r).forEach(function(o){o.classList.toggle("easy-points-hide")})}function showTierDataToggleSection(){var t=document.getElementById("widget-tier-data-toggle-container");t&&t.classList.remove("easy-points-hide")}function updateRankMaintenanceData(){var t=getEasyPointsSession(),e=t.rankMaintenanceData;if(e){var a=document.querySelectorAll('[data-loyal-target="rank-maintenance-amount"]'),n=Array.prototype.slice.call(a);n.forEach(function(d){d.textContent=e.amount});var l;e.deadline?(l=new Date(e.deadline),l=l.toLocaleDateString("ja")):l="N/A";var r=document.querySelectorAll('[data-loyal-target="rank-maintenance-deadline"]'),o=Array.prototype.slice.call(r);o.forEach(function(d){d.textContent=l})}var u=t.rankAdvancementData;if(u){var A=document.querySelectorAll('[data-loyal-target="rank-advancement-amount"]'),I=Array.prototype.slice.call(A);I.forEach(function(d){d.textContent=u.amount});var y;u.deadline?(y=new Date(u.deadline),y=y.toLocaleDateString("ja")):y="N/A";var L=document.querySelectorAll('[data-loyal-target="rank-advancement-deadline"]'),q=Array.prototype.slice.call(L);q.forEach(function(d){d.textContent=y});var O=document.querySelectorAll('[data-loyal-target="rank-advancement-tier-name"]'),P=Array.prototype.slice.call(O);P.forEach(function(d){d.textContent=u.tier_name})}}function getEasyPointsSession(){var t=sessionStorage.getItem("easyPoints");return t?t=JSON.parse(t):t={},t}function setEasyPointsSession(t){sessionStorage.setItem("easyPoints",JSON.stringify(t))}function setEasyPointsSessionItem(t,e){var a=getEasyPointsSession();a[t]=e,setEasyPointsSession(a)}function removeEasyPointsSessionItem(t){var e=getEasyPointsSession();delete e[t],setEasyPointsSession(e)}function greaterScriptVersion(t){var e="1-10-5";if(e){var a=/(\d+)\-(\d+)\-(\d+)/,n=e.match(a),l=parseInt(n[1]),r=parseInt(n[2]),o=parseInt(n[3]),u=t.match(a),A=parseInt(u[1]),I=parseInt(u[2]),y=parseInt(u[3]);return l>A?!0:l==A?r>I?!0:r==I?o>y:!1:!1}else return!0}var EasyPointsUI={BALANCE_EXPIRATION_CONTAINER_SELECTOR:'[data-loyal-target="balance-expiration"]',BALANCE_EXPIRATION_DATE_SELECTORS:{YY:'[data-loyal-target="balance-expiration__yy"]',MM:'[data-loyal-target="balance-expiration__mm"]',DD:'[data-loyal-target="balance-expiration__dd"]'},renderBalanceExpiration:function(t){var e=document.body.querySelectorAll(EasyPointsUI.BALANCE_EXPIRATION_CONTAINER_SELECTOR);if(e.length!=0){if(t==null){e.forEach(function(r){r.classList.add("easy-points-hide")});return}t=new Date(Date.parse(t));var a=t.getFullYear(),n=t.getMonth()+1,l=t.getDate();e.forEach(function(r){r.classList.remove("easy-points-hide"),r.querySelectorAll(EasyPointsUI.BALANCE_EXPIRATION_DATE_SELECTORS.YY).forEach(function(o){o.textContent=a}),r.querySelectorAll(EasyPointsUI.BALANCE_EXPIRATION_DATE_SELECTORS.MM).forEach(function(o){o.textContent=n}),r.querySelectorAll(EasyPointsUI.BALANCE_EXPIRATION_DATE_SELECTORS.DD).forEach(function(o){o.textContent=l})})}}};window.addEventListener("load",function(){var t=getEasyPointsSession(),e=document.getElementById("cart-item_count"),a=t.appliedDiscount;a&&parseInt(a)>0&&(displayAppliedDiscount(),updateDiscountInfo()),t.widgetHidden!==!0&&e&&e.value>0&&window.screen.width>1200&&window.screen.height>1300&&expandWidget(),updateLoyaltyTargets();var n=document.getElementById("redemption_button");n&&n.addEventListener("click",submitRedemptionForm),(widgetRedemptionButton=document.getElementById("widget-redemption-button"))&&widgetRedemptionButton.addEventListener("click",submitRedemptionForm);var l=document.getElementById("widget-reset-button");l&&l.addEventListener("click",submitResetForm);var r=document.getElementById("widget-close-btn");r&&r.addEventListener("click",hideWidget);var o=document.getElementById("widget-minimized");o&&o.addEventListener("click",showWidget);var u=document.getElementById("shown-point-value");if(u&&(u.addEventListener("change",updateRedemptionForm),u.addEventListener("focus",function(){u.setAttribute("placeholder","")}),u.addEventListener("blur",function(){u.setAttribute("placeholder","0")})),greaterScriptVersion("0-3-2")){var A=document.getElementsByClassName("widget-tier-data-toggle"),I=Array.prototype.slice.call(A);I.forEach(function(f){f.addEventListener("click",toggleWidgetTierData)});var y=t.tierName;if(y){var L=document.querySelectorAll('[data-loyal-target="tier-name"]'),q=Array.prototype.slice.call(L);q.forEach(function(f){f.textContent=y}),showTierDataToggleSection()}updateRankMaintenanceData()}function O(f,p){setTimeout(function(){f()},0)}var P=document.getElementById("shopDomain"),d=P?P.value:null,M=document.body.querySelector('input[data-loyal-target="redirect_url"]');M&&(M.value=window.location.pathname);var H=document.getElementById("customerId"),T=H?H.value:null,k=document.getElementById("customerHash"),R=k?k.value:null;function X(){if(d){var f="/apps/loyalty/order_point_rule";T&&R&&(f=f+"?sid="+T+"&hash="+R);var p=new XMLHttpRequest,c="https://"+d+f;p.open("GET",c),p.onload=function(){if(p.status===200){var m=getEasyPointsSession(),s=document.body.querySelector('input[data-loyal-target="shop-point-rule-percent"]'),g=document.body.querySelector('input[data-loyal-target="shop-point-rule-point-value"]'),_=document.body.querySelector('input[data-loyal-target="shop-point-rule-currency-value"]'),v=JSON.parse(p.response),w=parseInt(v.percentage),E=parseInt(v.point_value),B=parseInt(v.currency_value),x=v.tier_name,S=document.querySelectorAll('[data-loyal-target="tier-name"]'),C=Array.prototype.slice.call(S);C.forEach(function(h){h.textContent=x}),showTierDataToggleSection(),s.value=w,g.value=E,_.value=B,m&&(m.customerPointRulePointValue=E,m.customerPointRuleCurrencyValue=B,m.tierName=x,v.tier_maintenance_data&&(m.rankMaintenanceData=v.tier_maintenance_data.maintenance_data,m.rankAdvancementData=v.tier_maintenance_data.advancement_data,setEasyPointsSession(m),updateRankMaintenanceData())),S=document.querySelectorAll('[data-loyal-target="point-value"]'),C=Array.prototype.slice.call(S);var N=[],J=[];C.forEach(function(h){var V=h.getAttribute("data-loyal-bonus-points");(V?N:J).push(h)}),N.concat(J).forEach(function(h){var V=Shopify&&Shopify.currency&&Shopify.currency.rate||1,W=parseInt(h.dataset.loyalCurrencyCost)/(100*V),D=W*(E/B),z=h.querySelector('[data-loyal-target="point-value-location"]'),b=h.getAttribute("data-loyal-bonus-points");if(b){b=JSON.parse(b);var G=b.pointValue/b.currencyValue,U=b.quantity||1;b.bonusPoints=Math.floor(W*G*U),h.setAttribute("data-loyal-bonus-points",JSON.stringify(b)),D+=b.bonusPoints}h.hasAttribute("data-loyal-cart-subtotal")&&(D+=totalBonusPoints()),h.dataset.loyalRound==="up"?D=Math.ceil(D):D=Math.floor(D),z.textContent=formatBigNumber(D)})}},p.send()}}function F(){if(T&&R&&d){var f="/apps/loyalty/point_balances?sid="+T+"&hash="+R,p=new XMLHttpRequest;p.open("GET","https://"+d+f),p.onload=function(){if(p.status===200){var c=JSON.parse(p.response),m=document.body.querySelectorAll('[data-loyal-target="balance"]'),s=getEasyPointsSession();s&&(s.pointBalance=c.balance,s.expirationDate=c.expiration_date),m.forEach(function(E){E.textContent=formatBigNumber(c.balance)}),EasyPointsUI.renderBalanceExpiration(c.expiration_date);var g=document.getElementById("max-redeemable-points");if(g){var _=parseInt(g.textContent.replace(/[^\d]/g,""));g.textContent=formatBigNumber(Math.min(_,c.balance))}if(typeof c.coupon_value=="number"&&c.coupon_value>0){var v=document.getElementById("shown-point-value");v&&(v.value=c.coupon_value);var w=document.getElementById("redemption-point-value");w&&(w.value=c.coupon_value),eles=document.querySelectorAll('[data-loyal-target="applied-discount"]'),eles.forEach(function(E){E.textContent=c.coupon_currency}),s&&(s.appliedDiscount=c.coupon_value,s.appliedDiscountCurrency=c.coupon_currency,setEasyPointsSession(s)),updateDiscountInfo()}else s&&(delete s.appliedDiscount,delete s.appliedDiscountCurrency);s&&setEasyPointsSession(s)}},p.send()}}function Y(){orderIds=[];var f=document.querySelectorAll("[data-loyal-order-points]"),p=Array.prototype.slice.call(f);if(p.forEach(function(_){var v=_.querySelectorAll("[data-loyal-order-id]"),w=Array.prototype.slice.call(v);w.forEach(function(E){var B=E.getAttribute("data-loyal-order-id");orderIds.push(B)})}),orderIds.length>0&&T&&R&&d){var c="/apps/loyalty/orders",m={sid:T,hash:R,order_ids:orderIds},s=new URLSearchParams(m),g=new XMLHttpRequest;g.open("GET","https://"+d+c+"?"+s.toString()),g.onload=function(){if(g.status===200){var _=JSON.parse(g.response);p.forEach(function(v){var w=v.querySelectorAll("[data-loyal-order-id]"),E=Array.prototype.slice.call(w);E.forEach(function(B){var x=B.getAttribute("data-loyal-order-id"),S=_.orders[x];S&&B.querySelectorAll("[data-loyal-target]").forEach(function(C){var N=C.getAttribute("data-loyal-target");N=="awardable-points"?C.innerHTML=formatBigNumber(S.awardable_points):N=="points-redeemed"?C.innerHTML=formatBigNumber(S.points_redeemed):N=="points-awarded"&&(C.innerHTML=formatBigNumber(S.points_awarded))})})})}},g.send()}}O(X),O(F),O(Y)});
//# sourceMappingURL=/s/files/1/0383/1339/4308/t/20/assets/easy_points.js.map?v=168535346262269294121604292561
