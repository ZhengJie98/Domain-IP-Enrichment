<!DOCTYPE html>
<html>
  {% include 'layout.html' %}

  <head>
    <title>MongoDB Records</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/assets/css/custom.css">

    <style>
      table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }

      .filter-form {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .filter-form label {
        margin-right: 10px;
      }

      .filter-form select,
      .filter-form input {
        padding: 4px;
      }

      .filter-form input[type="submit"] {
        padding: 4px 8px;
      }

      .pagination {
        margin-top: 20px;
        display: flex;
        justify-content: center;
      }

      .pagination a {
        text-decoration: none;
        padding: 8px 16px;
        border: 1px solid #ddd;
        margin: 0 4px;
      }

      .pagination a.active {
        background-color: #4CAF50;
        color: white;
      }

      .pagination a:hover:not(.active) {
        background-color: #ddd;
      }

      /* Add a new style for empty records */
      .empty-records {
        text-align: center;
        margin-top: 20px;
      }
    </style>
  </head>

  <body>
    <h1>MongoDB Records</h1>
    <form class="filter-form" action="/filter" method="GET">
      <label for="filter_header">Filter Header:</label>
      <select id="filter_header" name="filter_header">
        {% for field_name in unique_keys if paginated_records %}
          {% if field_name not in ['files_log','_id','to_skip'] %}
            <option value="{{ field_name }}">{{ field_name }}</option>
          {% endif %}
        {% endfor %}
      </select>
      <label for="filter_value">Filter Value:</label>
      <input type="text" id="filter_value" name="filter_value">
      <input type="hidden" id="type_header" name="type_header" value="{{ type_header }}">
      <input type="submit" value="Apply Filter">
    </form>
    <a href="/exportcsv?type_header=domain" class="btn btn-primary">Export to CSV</a>
    <br>
    <!-- <form action="/upload" method="POST" enctype="multipart/form-data">
      <input type="file" name="csv_file">
      <input type="submit" value="Upload CSV">
    </form> -->
    <br>
    <table>
      <thead>
        <tr>
          {% if paginated_records and paginated_records[0] %}
          {% for field_name in unique_keys %}
              {% if field_name not in ['files_log','_id','to_skip'] %}
                <th>{{ field_name }}</th>
              {% endif %}
            {% endfor %}
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% if paginated_records %}
          {% for record in paginated_records %}
            <tr>
              {% for curr_key in unique_keys %}
                {% if curr_key not in record %}
                  <td></td>
                {% elif (curr_key in record) and curr_key not in ['files_log','_id','to_skip'] %} 
                  {% for field_name, field_value in record.items() %}
                    {% if (curr_key == field_name) %}
                      <td> {{field_value}} </td>
                  
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="100%" class="empty-records">No records found.</td>
          </tr>
        {% endif %}
      </tbody>
      
    </table>

    <div class="pagination">
      {% if has_prev %}
        <a href="?page={{ prev_page }}">Previous</a>
      {% endif %}

      {% set group_size = 10 %}
      {% set group_start = current_page // group_size * group_size + 1 %}
      {% set group_end = (current_page // group_size + 1) * group_size %}

      {% if group_start > 1 %}
        <a href="?page=1">1</a>
        {% if group_start > group_size + 1 %}
          <span>...</span>
        {% endif %}
      {% endif %}

      {% for page_num in range(group_start, group_end + 1) %}
        {% if page_num <= total_pages %}
          {% if page_num == current_page %}
            <a href="?page={{ page_num }}" class="active">{{ page_num }}</a>
          {% else %}
            <a href="?page={{ page_num }}">{{ page_num }}</a>
          {% endif %}
        {% endif %}
      {% endfor %}

      {% if group_end < total_pages %}
        {% if group_end < total_pages - group_size %}
          <span>...</span>
        {% endif %}
        <a href="?page={{ total_pages }}">{{ total_pages }}</a>
      {% endif %}

      {% if has_next %}
        <a href="?page={{ next_page }}">Next</a>
      {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
